#!/usr/bin/env nix
#!nix shell --inputs-from . nixpkgs#bash nixpkgs#curl nixpkgs#jq nixpkgs#alejandra -c bash
# shellcheck shell=bash
set -euo pipefail

# Query supported targets
targets=$(nix eval --json --inputs-from . --apply builtins.attrNames nixpkgs#legacyPackages)

echo "Fetching index.json" >&2
index=$(curl -L https://ziglang.org/download/index.json | jq -c --argjson targets "$targets" '
    def to_zig_targets:
        sub("-darwin$"; "-macos") |
        sub("i686-"; "x86-") |
        sub("armv7l-"; "arm-", "armv7a-");

    with_entries(.value = (
        [
            {_date : .value.date, _version: .value.version // .key},
            ($targets[], "src") as $target | {
                ($target): .value[$target | to_zig_targets] // empty | {
                    filename: .tarball | capture("/(?<f>[^/]+)$").f,
                    shasum,
                },
            }
        ] | add
    ))
')

json2nix() {
    nix-instantiate --eval --arg-from-stdin json --expr '{json}: builtins.fromJSON json' | alejandra -q
}
comment='# Autogenerated by update-releases.sh, do not modify'

echo "Generating stable.nix" >&2
stable=$(jq -cr 'del(.master) | [.[]] | sort_by(._date)' <<<"$index" | json2nix)
printf '%s\n' "$comment" "$stable" >releases/stable.nix

echo "Updating nightly.nix" >&2
nightly=$(nix eval --json --file releases/nightly.nix | jq -cr --argjson index "$index" '
    if .[-1]._date == $index.master._date then
        .[:-1] # Give priority to the freshly generated release
    end |
    . + [$index.master] |

    # Check list is sorted
    if . != sort_by(._date) then
        error("Nightly releases are not sorted")
    end
' | json2nix)
printf '%s\n' "$comment" "$nightly" >releases/nightly.nix

echo "Fetching community mirror list" >&2
curl -Lo releases/community-mirrors.txt https://ziglang.org/download/community-mirrors.txt
